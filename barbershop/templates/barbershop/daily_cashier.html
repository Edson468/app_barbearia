{% extends 'products/base.html' %}

{% block title %}Caixa{% endblock %}

{% block extra_css %}
<style>
  @media (max-width: 768px) {
    .summary-cards {
      grid-template-columns: 1fr !important;
    }
    .summary-cards .card {
      min-height: auto;
      padding: 1rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
  <h3 class="text-2xl font-semibold text-gray-800">Relatório de Caixa</h3>
  <div class="flex flex-wrap gap-2 justify-end">
    <a href="{% url 'barbershop:add_expense' %}" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center gap-2">
      <i class="fas fa-minus-circle"></i> Nova Despesa
    </a>
    <a href="{% url 'barbershop:export_cashier_csv' %}?{{ query_params }}" class="bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center gap-2">
      <i class="fas fa-file-csv"></i> Exportar CSV
    </a>
  </div>
</div>

<!-- Filtros -->
<div class="bg-white rounded-lg shadow p-4 md:p-6 mb-6">
  <h5 class="text-lg font-bold text-gray-800 mb-4">Filtros</h5>
  <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
    <div class="lg:col-span-1">
      <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
      <input type="date" name="filter_date" value="{{ filter_date }}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
    </div>
    <div class="lg:col-span-1">
      <label class="block text-sm font-medium text-gray-700 mb-1">Mês/Ano</label>
      <input type="month" name="filter_month" value="{{ filter_month }}" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
    </div>
    <div class="lg:col-span-1">
      <label class="block text-sm font-medium text-gray-700 mb-1">Serviço</label>
      <select name="filter_service_type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        <option value="">Todos</option>
        {% for st in service_types %}
          <option value="{{ st.id }}" {% if filter_service_type == st.id|stringformat:"s" %}selected{% endif %}>{{ st.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="lg:col-span-1">
      <label class="block text-sm font-medium text-gray-700 mb-1">Barbeiro</label>
      <select name="filter_barber" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        <option value="">Todos</option>
        {% for barber in barbers %}
          <option value="{{ barber.id }}" {% if filter_barber == barber.id|stringformat:"s" %}selected{% endif %}>{{ barber.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="lg:col-span-1">
      <label class="block text-sm font-medium text-gray-700 mb-1">Pagamento</label>
      <select name="filter_payment_method" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        <option value="">Todos</option>
        {% for value, name in payment_methods %}
          <option value="{{ value }}" {% if filter_payment_method == value %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="lg:col-span-1 flex flex-col justify-end gap-2">
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">Aplicar</button>
      <a href="{% url 'barbershop:daily_cashier' %}" class="w-full text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md">Limpar</a>
    </div>
  </form>
</div>

<!-- Resumo Financeiro -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 summary-cards">
  <div class="card bg-green-50 border border-green-200 rounded-lg p-4 text-center shadow-sm">
    <h5 class="font-semibold text-green-800 text-sm">Receitas (Serviços)</h5>
    <p class="text-2xl font-bold text-green-700 mt-1">R$ {{ total_income|floatformat:2 }}</p>
  </div>
  <div class="card bg-red-50 border border-red-200 rounded-lg p-4 text-center shadow-sm">
    <h5 class="font-semibold text-red-800 text-sm">Despesas</h5>
    <p class="text-2xl font-bold text-red-700 mt-1">R$ {{ total_outcome|floatformat:2 }}</p>
  </div>
  <div class="card bg-blue-50 border {% if total_value >= 0 %}border-blue-200{% else %}border-red-300{% endif %} rounded-lg p-4 text-center shadow-sm">
    <h5 class="font-semibold text-gray-800 text-sm">Total Líquido</h5>
    <p class="text-2xl font-bold {% if total_value >= 0 %}text-blue-700{% else %}text-red-700{% endif %} mt-1">R$ {{ total_value|floatformat:2 }}</p>
  </div>
</div>

<!-- Total de Serviços -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6 text-center">
  <h5 class="font-semibold text-blue-800">Total de Serviços Pagos: <span class="font-bold">{{ total_services }}</span></h5>
</div>

<!-- Tabela de Transações -->
<div class="bg-white rounded-lg shadow overflow-hidden">
  <div class="p-4 md:p-6">
    <h5 class="text-lg font-bold text-gray-800">Transações (Receitas e Despesas)</h5>
  </div>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Barbeiro</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Forma Pag.</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for transaction in transactions %}
        <tr class="{% if transaction.is_expense %}bg-red-50 hover:bg-red-100{% else %}hover:bg-gray-50{% endif %}">
          <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">{{ transaction.sort_time|date:"d/m/Y H:i" }}</td>
          <td class="px-4 py-3 text-sm font-medium {% if transaction.is_expense %}text-red-600{% else %}text-green-600{% endif %}">
            {{ transaction.get_type_display }}
          </td>
          <td class="px-4 py-3 text-sm text-gray-800 max-w-xs truncate">{{ transaction.description }}</td>
          <td class="px-4 py-3 text-sm text-gray-600 hidden sm:table-cell">{{ transaction.barber }}</td>
          <td class="px-4 py-3 text-sm text-gray-600 hidden md:table-cell">{{ transaction.payment_method }}</td>
          <td class="px-4 py-3 text-right text-sm font-medium {% if transaction.is_expense %}text-red-600{% else %}text-green-600{% endif %}">
            R$ {{ transaction.value|floatformat:2 }}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-6 text-center text-gray-500">Nenhuma transação encontrada.</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="bg-gray-50 font-medium">
        <tr>
          <td colspan="5" class="px-4 py-3 text-right text-sm text-gray-700">Total Receitas</td>
          <td class="px-4 py-3 text-right text-green-600">R$ {{ total_income|floatformat:2 }}</td>
        </tr>
        <tr>
          <td colspan="5" class="px-4 py-3 text-right text-sm text-gray-700">Total Despesas</td>
          <td class="px-4 py-3 text-right text-red-600">R$ {{ total_outcome|floatformat:2 }}</td>
        </tr>
        <tr class="border-t border-gray-300">
          <td colspan="5" class="px-4 py-3 text-right text-base font-bold text-gray-800">Total Líquido</td>
          <td class="px-4 py-3 text-right text-lg font-bold {% if total_value >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">
            R$ {{ total_value|floatformat:2 }}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

{% endblock %}